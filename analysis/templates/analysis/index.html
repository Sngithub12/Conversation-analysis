<!DOCTYPE html>
<html>
<head>
  <title>Conversation Analyzer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="p-4">

  <h2>Upload Conversation</h2>
  <textarea id="convInput" class="form-control" rows="6" placeholder='Paste JSON messages here'></textarea>
  <button class="btn btn-primary mt-2" onclick="uploadConversation()">Upload</button>

  <hr>

  <h2>Analyse Conversation</h2>
  <select id="convSelect" class="form-select mb-2"></select>
  <button class="btn btn-success" onclick="analyseConversation()">Analyse</button>

  <hr>

  <h2>Reports</h2>
  <div id="reports"></div>

<script>
const BASE_URL = "http://127.0.0.1:8000/api";
let convMap = {};

async function fetchReports() {
  const res = await fetch(`${BASE_URL}/reports/`);
  const data = await res.json();
  const select = document.getElementById("convSelect");
  select.innerHTML = "";
  const reportsDiv = document.getElementById("reports");
  reportsDiv.innerHTML = "";

  data.forEach(r => {
    convMap[r.conversation] = r.id;
    const option = document.createElement("option");
    option.value = r.id;
    option.text = `Conversation #${r.id}`;
    select.appendChild(option);

    // Display report
    const card = document.createElement("div");
    card.className = "card mb-2 p-2";
    card.innerHTML = `
      <strong>Conversation ID:</strong> ${r.conversation} <br>
      <strong>Clarity:</strong> ${r.clarity_score}, 
      <strong>Relevance:</strong> ${r.relevance_score}, 
      <strong>Accuracy:</strong> ${r.accuracy_score}, 
      <strong>Overall:</strong> ${r.overall_score} <br>
      <strong>Sentiment:</strong> ${r.sentiment}, 
      <strong>Resolution:</strong> ${r.resolution}
    `;
    reportsDiv.appendChild(card);
  });
}





async function uploadConversation() {
  let messages;
  try {
    messages = JSON.parse(document.getElementById("convInput").value);
  } catch(e) {
    return alert("Invalid JSON!");
  }

  
conv_id = request.data.get('conversation_id')
conv = Conversation.objects.get(id=conv_id)



async function analyseConversation() {
  const conv_id = document.getElementById("convSelect").value;
  const res = await fetch(`${BASE_URL}/analyse/`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({conversation_id: conv_id})
  });
  const data = await res.json();
  alert(`Analysis Complete for Conversation #${conv_id}`);
  fetchReports();
}
}

// Initial fetch
fetchReports();
</script>

</body>
</html>
